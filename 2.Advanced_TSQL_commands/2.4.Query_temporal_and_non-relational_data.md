## 2.4 Query temporal tables, XML and JSON

### Temporal tables

#### What is?
  Temporal tables is a new resource of MSSQL 2016, we can store changes of data about a table, like auditing data. Every change in the data, are storaged into a historical table. Is very usefull to see in a specific range of data, the changes in the data.

#### Do it!
  Well, the *Temporal Table* have some prerequisites. The table that you wanna trasform into a temporal table should have two columns `datetime2`, one that storage the **start time** and another to storage the **end time**. Some clauses should be included to create this columns, lets see the commands to create a temporal table:

  ```sql
  CREATE TABLE dbo.Person (
    person_id  int identity(1,1) primary key --//need a primary key
   ,first_name varchar(50)
   ,midle_name varchar(50)
   ,last_name  varchar(50)
   ,birthdate  date
   ,startdate  datetime2(3) GENERATED ALWAYS AS ROW START NOT NULL
   ,enddate    datetime2(3) GENERATED ALWAYS AS ROW END NOT NULL
   ,PERIOD FOR SYSTEM_TIME (startdate, enddate)
  ) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.Person_History)) --//SQL Server generate automatically a history table for us
  ```
  
  Note the clauses  `GENERATED ALWAYS AS ROW [START | END]`, `PERIOD FOR SYSTEM_TIME` and `SYSTEM_VERSIONING = ON`, with this commands we can create a _temporal table_, with the fist command we defined the columns that control the start and end date for a row, with the `PERIOD FOR SYSTEM TIME` informs the the start and end columns and turn on the `SYSTEM_VERSIONING`, if you don't inform a table the SQL Server create a table for you. Otherwise we can transform  a normal table to a temporal table too, let's code:

  ```sql
  CREATE TABLE dbo.Car(
    car_id   integer identity(1,1) primary key
   ,model    varchar(100)
   ,car_year smallint
  );

  INSERT INTO dbo.Car(model, car_year)
  VALUES('Test Model', 2005);

  --//if your table have any rows you need a default constraint

  ALTER TABLE dbo.Car
  ADD startdate datetime2(3) GENERATED ALWAYS AS ROW START HIDDEN NOT NULL CONSTRAINT DF_Car_startdate DEFAULT ('19000101 00:00:00.000')
     ,enddate  datetime2(3) GENERATED ALWAYS AS ROW END HIDDEN NOT NULL CONSTRAINT DF_Car_enddate DEFAULT ('99991231 23:59:59.999')
     ,PERIOD FOR SYSTEM_TIME(startdate, enddate);

  ALTER TABLE dbo.Car
  SET (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.Car_History));
  ```

  If you need drop a temporal table, first turn off the `SYSTEM_VERSIONING`:
  ```sql
  ALTER TABLE dbo.Person
  SET (SYSTEM_VERSIONING = OFF);

  DROP TABLE dbo.Person;
  ```

  Whell, created the table, let's modify some data, first populate the person table:
  ```sql
  INSERT INTO dbo.Person (first_name, midle_name, last_name, birthdate)
  VALUES('Adrian', 'Hideki', 'San', '19981231');

  INSERT INTO dbo.Person (first_name, midle_name, last_name, birthdate)
  VALUES('Maria', 'San', 'Desu', '20000126');

  INSERT INTO dbo.Person (first_name, midle_name, last_name, birthdate)
  VALUES('Ronald', 'Fenomeno', 'IX', '19781025');
  ```

  Now, look at the data into Person table:
  ```
  person_id   first_name   midle_name   last_name  birthdate  startdate                   enddate
  ----------- ------------ ------------ ---------- ---------- --------------------------- ---------------------------
  1           Adrian       Hideki       San        1998-12-31 2018-11-26 00:31:47.440     9999-12-31 23:59:59.999
  2           Maria        San          Desu       2000-01-26 2018-11-26 00:32:19.103     9999-12-31 23:59:59.999
  3           Ronald       Fenomeno     IX         1978-10-25 2018-11-26 00:32:55.487     9999-12-31 23:59:59.999

  ```

  When we insert data into a temporal table, the history table don't add the inserted data, only deleted and updated rows are storaged into the history table, a interesting thing is the `startdate`, this field show when the record was inserted. Let's modify some data and look at Person and Person_History table:
  ```sql
  ```

#### References
[Microsoft Documentation](https://docs.microsoft.com/pt-br/sql/relational-databases/tables/temporal-tables)