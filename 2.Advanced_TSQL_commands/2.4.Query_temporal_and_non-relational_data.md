## 2.4 Query temporal tables, XML and JSON

### Temporal tables

#### What is?
  Temporal tables is a new resource of MSSQL 2016, we can store changes of data about a table, like auditing data. Every change in the data, are storaged into a historical table. Is very usefull to see in a specific range of data, the changes in the data.

#### Do it!
  Well, the *Temporal Table* have some prerequisites. The table that you wanna trasform into a temporal table should have two columns `datetime2`, one that storage the **start time** and another to storage the **end time**. Some clauses should be included to create this columns, lets see the commands to create a temporal table:

  ```sql
  CREATE TABLE dbo.Person (
    person_id  int identity(1,1) primary key --//need a primary key
   ,first_name varchar(50)
   ,midle_name varchar(50)
   ,last_name  varchar(50)
   ,birthdate  date
   ,startdate  datetime2(3) GENERATED ALWAYS AS ROW START NOT NULL
   ,enddate    datetime2(3) GENERATED ALWAYS AS ROW END NOT NULL
   ,PERIOD FOR SYSTEM_TIME (startdate, enddate)
  ) WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.Person_History)) --//SQL Server generate automatically a history table for us
  ```
  
  Note the clauses  `GENERATED ALWAYS AS ROW [START | END]`, `PERIOD FOR SYSTEM_TIME` and `SYSTEM_VERSIONING = ON`, with this commands we can create a _temporal table_, with the fist command we defined the columns that control the start and end date for a row, with the `PERIOD FOR SYSTEM TIME` informs the the start and end columns and turn on the `SYSTEM_VERSIONING`, if you don't inform a table the SQL Server create a table for you. Otherwise we can transform  a normal table to a temporal table too, let's code:

  ```sql
  CREATE TABLE dbo.Car(
    car_id   integer identity(1,1) primary key
   ,model    varchar(100)
   ,car_year smallint
  );

  INSERT INTO dbo.Car(model, car_year)
  VALUES('Test Model', 2005);

  --//if your table have any rows you need a default constraint

  ALTER TABLE dbo.Car
  ADD startdate datetime2(3) GENERATED ALWAYS AS ROW START HIDDEN NOT NULL CONSTRAINT DF_Car_startdate DEFAULT ('19000101 00:00:00.000')
     ,enddate  datetime2(3) GENERATED ALWAYS AS ROW END HIDDEN NOT NULL CONSTRAINT DF_Car_enddate DEFAULT ('99991231 23:59:59.999')
     ,PERIOD FOR SYSTEM_TIME(startdate, enddate);

  ALTER TABLE dbo.Car
  SET (SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.Car_History));
  ```

  If you need drop a temporal table, first turn off the `SYSTEM_VERSIONING`, doing this the history table turn to a normal table, and you need to delete that table too:
  ```sql
  ALTER TABLE dbo.Person
  SET (SYSTEM_VERSIONING = OFF);

  DROP TABLE dbo.Person;
  DROP TABLE dbo.Person_History;
  ```

  Whell, created the table, let's modify some data, first populate the person table:
  ```sql
  INSERT INTO dbo.Person (first_name, midle_name, last_name, birthdate)
  VALUES('Adrian', 'Hideki', 'San', '19981231');

  INSERT INTO dbo.Person (first_name, midle_name, last_name, birthdate)
  VALUES('Maria', 'San', 'Desu', '20000126');

  INSERT INTO dbo.Person (first_name, midle_name, last_name, birthdate)
  VALUES('Ronald', 'Fenomeno', 'IX', '19781025');
  ```

  Now, look at the data into Person table:
  ```
  person_id   first_name   midle_name   last_name  birthdate  startdate                   enddate
  ----------- ------------ ------------ ---------- ---------- --------------------------- ---------------------------
  1           Adrian       Hideki       San        1998-12-31 2018-11-26 00:31:47.440     9999-12-31 23:59:59.999
  2           Maria        San          Desu       2000-01-26 2018-11-26 00:32:19.103     9999-12-31 23:59:59.999
  3           Ronald       Fenomeno     IX         1978-10-25 2018-11-26 00:32:55.487     9999-12-31 23:59:59.999

  ```

  When we insert data into a temporal table, the history table don't add the inserted data, only deleted and updated rows are storaged into the history table, a interesting thing is the `startdate`, this field show when the record was inserted. Let's try modify some data and look at Person and Person_History table:
  ```sql
  UPDATE dbo.Person
  SET midle_name = 'Bideki'
  WHERE person_id = 1

  SELECT *
  FROM dbo.Person
  ```
  This results:
  ```
  Person_id   first_name   midle_name  last_name  birthdate  startdate                   enddate
  ----------- ------------ ----------- ---------- ---------- --------------------------- ---------------------------
  1           Adrian       Bideki      San        1998-12-31 2018-11-27 00:22:43.911     9999-12-31 23:59:59.999
  2           Maria        San         Desu       2000-01-26 2018-11-26 00:32:19.103     9999-12-31 23:59:59.999
  3           Ronald       Fenomeno    IX         1978-10-25 2018-11-26 00:32:55.487     9999-12-31 23:59:59.999
  ```

  The start date has change, let's see the history table:
  ```sql
  SELECT *
  FROM dbo.Person_History;
  ```

  ```
  person_id   first_name  midle_name  last_name   birthdate  startdate                   enddate
  ----------- ----------- ----------- ----------- ---------- --------------------------- ---------------------------
  1           Adrian      Hideki      San         1998-12-31 2018-11-26 00:31:47.440     2018-11-27 00:22:43.911
  ```

  Observe the `startdate` and `enddate` columns, the value represents of this columns representes the time when they are modified, the stardate presents the value of the last update, the enddate represents the actual update. Let's modify and delete some data:

  ```sql
  UPDATE dbo.Person
  SET midle_name = 'Hideki'
  WHERE person_id = 1

  DELETE FROM dbo.Person
  WHERE person_id > 1
  ```

  Look the `Person` and `Person_History` tables:
  ```sql
  SELECT * FROM dbo.Person

  SELECT * FROM dbo.Person_History
  ```

  ```
  person_id   first_name  midle_name  last_name  birthdate  startdate                enddate
  ----------- ----------- ----------- ---------- ---------- ------------------------ ------------------------
  1           Adrian      Hideki      San        1998-12-31 2018-11-27 00:57:16.226  9999-12-31 23:59:59.999
  
  person_id   first_name  midle_name  last_name  birthdate  startdate                enddate
  ----------- ----------- ----------- ---------- ---------- ------------------------ ------------------------
  1           Adrian      Hideki      San        1998-12-31 2018-11-26 00:31:47.440  2018-11-27 00:22:43.911
  1           Adrian      Bideki      San        1998-12-31 2018-11-27 00:22:43.911  2018-11-27 00:57:16.226
  2           Maria       San         Desu       2000-01-26 2018-11-26 00:32:19.103  2018-11-27 00:57:17.287
  3           Ronald      Fenomeno    IX         1978-10-25 2018-11-26 00:32:55.487  2018-11-27 00:57:17.287
  ```

  The deleted\updated records are storage into `Person_History`. We can note, when the data are modified the data are logged into history table. The columns `startdate`, `enddate` helps to know when the data are modified at a specif time. The enddate, represents when the transaction are commited, if we open a transaction and touch two records into a same transaction the `enddate` column should be storaged with the same date and time, but first let's recovery our deleted data:

  ```sql
  SET IDENTITY_INSERT dbo.Person ON;

  INSERT INTO dbo.Person(
    person_id
   ,first_name
   ,midle_name
   ,last_name
   ,birthdate)
  SELECT person_id
        ,first_name
        ,midle_name
        ,last_name
        ,birthdate
  FROM dbo.Person_History
  WHERE person_id > 1;

  SET IDENTITY_INSERT dbo.Person OFF;
  ```

  ```sql
  BEGIN TRAN;

  UPDATE dbo.Person
    SET midle_name = 'Xideki'
  WHERE person_id = 1;

  UPDATE dbo.Person
    SET last_name = 'Chan'
  WHERE person_id = 2;

  COMMIT;
  ```

  Look at `Person` and `Person_History` tables:
  ```sql
  SELECT * FROM dbo.Person WHERE person_id < 3;
  SELECT * FROM dbo.Person_History WHERE person_id < 3 AND enddate >= '2018-11-27 01:09:56.417';
  ```

  ```
  person_id   first_name   midle_name  last_name  birthdate  startdate                enddate
  ----------- ------------ ----------- ---------- ---------- ------------------------ ------------------------
  1           Adrian       Xideki      San        1998-12-31 2018-11-27 01:09:56.417  9999-12-31 23:59:59.999
  2           Maria        San         Chan       2000-01-26 2018-11-27 01:09:56.417  9999-12-31 23:59:59.999

  person_id   first_name  midle_name  last_name  birthdate  startdate                enddate
  ----------- ----------- ----------- ---------- ---------- ------------------------ ------------------------
  1           Adrian      Hideki      San        1998-12-31 2018-11-27 00:57:16.226  2018-11-27 01:09:56.417
  2           Maria       San         Desu       2000-01-26 2018-11-27 01:08:13.136  2018-11-27 01:09:56.417
  ```

  The `startdate` in the `Person` table show the same value for the two records, and the column `enddate` of `Person_History` table too.

#### Especif temporal table commands


#### References
[Microsoft Documentation](https://docs.microsoft.com/pt-br/sql/relational-databases/tables/temporal-tables)